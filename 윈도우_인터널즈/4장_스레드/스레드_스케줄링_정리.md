# 스레드 스케줄링 정리
## 1. IRQ 0번 타이머 인터럽트부터~
LIPC에 0번 타이머 인터럽트가 도착하면
* 현재 수행중인 스레드의 퀀텀이 모두 소비했는지 판단을 진행
  * 일반 윈도우 2 클록, 서버 윈도우 12 클록
* 타이머 인터럽트가 스레드 스케줄링의 수행 단위
  * 스레드는 클록 단위로 실행되지만 CPU 사이클 수를 통해 퀀텀 타겟(타임 슬라이스)을 선정하고 판단함
  * 클록 사이클 수로 판단하는 이유
    * 억울하게 퀀텀을 소진하는 스레드가 발생 가능(인터럽트 등)
    * 운 좋게 계속 수행되는 스레드가 발생 가능
  * 인터럽트 발생 등의 의해 실행 시간을 빼앗기는 경우 보정 작업이 진행됨

## 2. 디스패처의 발동
스케줄링 여부가 판단되면 디스패처를 발동시킴(DPC/Dispatcher IRQL 2 레벨)
* 먼저 원래 수행중이던 스레드의 정보를 백업함
  * 인스트럭션 포인터(IP), 커널 스택 포인터
  * PTD 포인터(CR3 레지스터) : 같은 프로세스의 스레드라면 교체될 필요가 없음
* 자기 자신의 레디큐를 보고 다음 수행할 스레드를 결정
* 만약 없다면 공유 레디큐에서 다음 수행할 스레드를 결정
* 여기도 없다면 유휴 스레드를 수행시킴

디스패처의 작업은 IRQL 2레벨에서 수행되므로 페이징 I/O 발생 불가능
* 만약 스레드의 커널 스택이 페이지 아웃 되어 있다면 트랜지션 상태에 두어 페이지 인을 대기하고 레디 상태로 옮김

레디 큐에 다른 스레드가 들어가면서 디스패처를 발동시키기도 함
* 선점 같은 경우

### 디스패처가 발동되는 경우
* 스레드가 레디 상태가 됨(레디큐에 스레드가 들어옴)
* 프로세서가 수행하던 스레드가 실행 상태를 벗어남(퀀텀 만료)
* 우선순위 혹은 친화도가 동적으로 변경됨

## 3. 다음 스레드가 수행됨
다시 수행되는 스레드는 디스패처의 코드부터 시작
* 저장한 레지스터 상태를 복원
* 원래의 스레드 코드를 수행

### 아무것도 수행할 스레드가 없을 때
유휴(Idle) 스레드가 수행됨
* 하는 일
  * 펜딩되었던 인터럽트/DPC 처리
  * 퀀텀 종료 처리
  * 다음 실행 스레드 검사
  * 요청이 있다면 다른 프로세서의 레디큐의 스레드를 스케줄링