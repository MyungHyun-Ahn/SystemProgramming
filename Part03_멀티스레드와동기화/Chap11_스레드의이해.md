# 11장 스레드의 이해
## Section 01 - 스레드가 무엇인가?
### 멀티 프로세스 기반 프로그램
* 둘 이상의 실행 흐름을 필요로 하는 프로그램인 경우
* 하나의 프로그램에서 둘 이상의 프로세스를 생성해서 처리해왔다.

### 멀티 프로세스 운영체제 기반 프로그램의 문제점과 새로운 제안
* 두 가지 이상의 일을 처리하기 위해 둘 이상의 실행흐름이 필요해서 프로세스를 생성하는 작업은 무겁다!
* 많은 수의 프로세스 실행은 빈번한 컨텍스트 스위칭으로 이어져 성능에 영향을 준다.
* 빈번하게 발생하는 컨텍스트 스위칭에 소요되는 시간을 줄이면 성능 향상을 기대할 수 있다.
* 저장하고 복원하는 컨텍스트 정보를 줄이면 된다!

A 프로세스와 B 프로세스가 완전히 별개가 아닌 50% 정도 공유하는 구조라면 컨텍스트 또한 줄지 않을까?
* 여기서 바로 스레드라는 것이 탄생한다.

### 해결책, 스레드
* 스레드는 하나의 프로그램에서 여러개의 실행 흐름을 가지기 위한 모델
* 스레드는 프로세스와 달리 데이터를 공유하는 요소가 존재
* 데이터를 공유하기 때문에 컨텍스트 스위칭에 걸리는 시간이 프로세스보다 짧음

### 메모리 구조 관점에서 본 프로세스와 스레드
* 프로세스는 생성 될 때마다 Code 영역, Data 영역, Heap 영역, Stack 영역 모두 독립적으로 생성된다.

* 하지만 스레드는 스택 영역만 독립적으로 생성할 뿐, 나머지 영역은 공유하는 구조이다.

스레드의 특성
1. 스레드마다 스택을 독립적으로 할당한다.
   * 실행 흐름의 추가를 위한 최소 조건이 독립된 스택의 제공이다.
2. 코드 영역을 공유한다.
   * 스레드의 메인 함수가 존재하는데 스레드의 메인 함수에서 코드 영역에 존재하는 모든 함수를 호출할 수 있다.
3. 데이터 영역과 힙을 공유한다.
   * IPC가 필요 없어졌다.
   * 힙과 데이터 영역을 공유하기 때문에 A가 접근 가능하면 B도 가능하다.
  

### Windows에서의 프로세스와 스레드
Windows 입장에서 프로세스는 단순히 스레드를 담는 상자에 불과하다.
* Windows 입장에서 프로세스는 상태를 가지지 않는다.
* Windows 에 있어 실행의 중심에 있는 것은 스레드이다.

그럼 프로세스 컨텍스트 스위칭은?
* 만약 스레드를 생성하지 않으면 앞에서 공부한 프로세스 컨텍스트 스위칭과 동일하다.

그런데 윈도우에서는 스레드를 생성하지 않는 프로세스는 없다!
* 컨텍스트 스위칭이 발생하더라도 스레드 간의 컨텍스트 스위칭에 불과하다.
* 프로세스를 실행하면 main 스레드가 생성, 이것은 프로그래머가 생성하는 스레드와 구분

## Section 02 - 스레드 구현 모델에 따른 구분
### 커널 레벨(Kernel Level) 스레드와 유저 레벨(User Level) 스레드
커널 레벨 스레드
* 프로그래머 요청에 따라 스레드를 생성 및 스케줄링하는 주체가 커널인 경우

유저 영역
* 코드 영역, 데이터 영역, 스택 영역, 힙 영역이 바로 유저 영역

커널 영역
* 유저 영역을 제외하고 모든 영역
* 운영체제라는 하나의 소프트웨어를 실행시키기 위해 필요한 공간

유저 레벨 스레드 모델
* 커널에서 스레드 기능을 지원하지 않을 때 생각해 볼 수 있는 것
* 라이브러리를 통해 제공받을 수 있다.
* 운영체제는 유저 레벨 스레드의 존재를 모른다.
* 스케줄러가 스케줄링하는 대상은 프로세스
* 스레드를 스케줄링하는 스케줄러 유저 영역

### 커널 모드(Kernel Mode)와 유저 모드(User Mode)
유저 영역에서 메모리 참조 오류가 발생하면, 프로그램만 오류

커널 영역에서 메모리 참조 오류가 발생하면, 시스템 오류로 치명적

* 따라서 안전성 제공 측면에서 다른 방법이 필요
* Windows 커널이 실행되야 하는 경우 커널 모드로 전환

커널 모드와 유저 모드
* 유저 모드 : 커널 영역으로 접근이 금지
* 커널 모드 : 유저 영역, 커널 영역 모두 접근 가능

시스템 함수를 호출 시 커널 모드로 전환이 필요하다.
  * 모드의 전환은 시스템에 부담을 주는 일

그럼 유저 모드와 커널 모드를 제공하는 건 Windows 운영체제?
* 아니다. 프로세서(Processor)가 제공
* 즉, 메모리 보호 기능이 CPU에 달려있다. 관련 내용은 이후 메모리 관련 부분에서

### 커널 레벨 스레드와 유저 레벨 스레드의 장단점

커널 레벨 스레드
* 장점 : 커널에서 직접 제공하기 때문에 안전성과 다양한 기능이 제공
* 단점 : 모드의 전환이 빈번하게 발생한다. 성능 저하

유저 레벨 스레드
* 장점 : 커널은 스레드 존재를 모른다. 유저 모드로만 동작하기 때문에 성능이 좋다.
* 단점 : 프로세스 내부에 여러개의 스레드가 존재해도 한 개의 스레드가 커널에 의해서 블락 당하면 프로세스 전체가 블록된다.

## 이것만은 알고 갑시다.
1. 프로세스와 스레드의 차이점

2. 커널 영역 vs 유저 영역
3. 커널 모드 vs 유저 모드
4. 커널 레벨 스레드 vs 유저 레벨 스레드