# Story02 - 서버의 수신 동작
## 1. LAN 어댑터에서 수신 신호를 디지털 데이터로 변환한다
수신 동작의 전체 모습
* 패킷의 신호를 LAN 어댑터에서 수신하고 디지털 데이터로 바꾸는 부분에서 시작
* LAN을 흐르는 패킷의 신호는 1과 0으로 이루어진 디지털 테이터의 신호화 타이밍을 나타내는 클록 신호를 합성한 것
* 여기서 1과 0의 디지털 데이터로 바꿀 수 있다.

10BASE-T의 동작
1. 프리앰블 부분에서 클록을 추출
    * 신호가 일정 간격으로 규칙적으로 변화, 변화의 타이밍을 조사하면 클록이 어느 위치에 있는지 알 수 있다.
2. 클록은 같은 간격으로 연장
3. 클록의 위치에서 신호의 변화의 방향을 조사
4. 클록의 변화의 방향대로 디지털 데이터에 대응

패킷의 맨 마지막에 있는 프레임 체크 시퀀스(FCS)를 통해 오류 검사
* 수신하여 디지털 데이터로 되돌리는 것을 오류 검사의 계산식에 따라 계산하고 패킷의 맨 끝에 있는 FCS 필드의 값과 비교
* 되돌린 디지털 데이터가 송신 전과 같으면 계산한 값과 맨 끝에 있는 값은 일치
* 일치하지 않는다면 수신한 데이터를 버린다.

MAC 헤더에 있는 수신처 MAC 주소를 조사하여 패킷이 자신을 수신처로 보낸 것인지 판단
* 다른 기기로 갈 신호는 버리고 자신에게 온 패킷만 남긴다.

디지털 데이터로 되돌린 것을 LAN 어댑터 내부의 버퍼 메모리에 저장
* 여기까지 LAN 어댑터의 MAC 부분이 실행

CPU는 패킷 도착 여부를 알지 못한다.
* 인터럽트라는 방법을 사용하여 LAN 어댑터에서 CPU로 패킷의 도착을 알림

이 시점에서 CPU는 실행하던 작업을 멈추고 LAN 어댑터로 실행을 전환
* LAN 어댑터의 버퍼 메모리에서 수신한 패킷을 추출
* TCP/IP의 프로토콜 스택을 호출하고 여기에 패킷을 건네줌

## 2. IP 담당 부분의 수신 동작
IP 헤더를 점검
* IP 헤더의 규칙이 올바르게 만들어졌는지
* 수신처 IP 주소가 자신의 것이 맞는지 등을 조사

라우터와 같이 패킷 중계 기능이 유효하게 된 경우
* 자신의 것이 아닌 패킷이 도착할 수 있다.
* 라우터와 같이 라우팅 테이블에서 중계 대상을 조사하고 그것에 패킷을 중계

자신의 것이 맞다면 조각 나누기에 의해 분할된 패킷인지 조사
* 분할된 경우 패킷을 일시적으로 메모리에 저장
* 분할된 패킷이 모두 도착한 시점에서 패킷의 조각을 모두 조립하여 복원
* 분할되지 않았다면 패킷은 원래 모습 그대로

프로토콜 번호를 확인하고 대상에 건네줌
* 06 값이라면 TCP 담당 부분에 패킷을 건네준다.
* 11이면 UDP 담당 부분

## 3. TCP 담당 부분이 접속 패킷을 수신했을 때의 동작
패킷의 TCP 헤더에 있는 SYN 비트가 1이라면 접속 동작의 패킷
* 패킷의 수신처 포트를 조사하여 이 번호와 같은 번호를 할당한 접속 대기 상태의 소켓이 있는지 확인
* 없다면 오류 통지 패킷을 클라이언트로 반송

접속 대기 소켓이 있다면
* 패킷을 복사하여 새 소켓을 만듬
* 소켓에 송신처 IP 주소, 포트번호, 시퀀스 번호의 초기값, 윈도우의 값 등 필요 정보 기록
* 패킷을 받았음을 나타내는 ACK 번호, 시퀀스 번호의 초기값, 수신 버퍼의 빈 용량을 나타내는 값 등의 항목을 담은 TCP 헤더를 만들어 반송
* 이것이 클라이언트로 돌아오면 접속 동작은 완료

이때 서버측의 애플리케이션은 accept를 호출하여 실행을 쉬는 상태
* 여기에 새로 만든 소켓의 디스크립터를 전달하여 서버 애플리케이션의 동작을 재개

## 4. TCP 담당 부분이 데이터 패킷을 수신했을 때의 동작
데이터 패킷이 도착한 경우의 동작
* TCP 담당 부분은 도착한 패킷이 어느 소켓에 해당하는지 조사
  * IP 헤더의 송신처 IP, 수신처 IP, TCP 헤더의 수신처 포트 번호, 송신처 포트 번호 4가지 정보가 모두 합치되는 소켓을 찾는다.
* 소켓을 찾으면
  * 패킷에 기록된 데이터 송수신의 진행 상황과 TCP 헤더의 정보를 결합하여 올바르게 진행되고 있는지 점검
  * 시퀀스 번호 계산
  * 시퀀스 번호가 일치하면 수신 버퍼에 저장
* 수신한 데이터를 수신 버퍼에 저장하면 수신 확인용 TCP 헤더를 만듬
  * ACK 번호를 기록
* IP 담당 부분에 의뢰하여 클라이언트에 반송

데이터 패킷을 수신했을 때의 동작은 수신 버퍼에 데이터 조각을 보관한 부분에서 일단 끝

이후 애플리케이션이 Socket 라이브러리의 read를 호출
* 수신한 데이터를 받아온 부분에서 애플리케이션에 건네줌
* 보통 데이터 패킷이 도착하기 전에 애플리케이션이 read를 호출하여 데이터의 도착을 기다리는 상태가 됨

## 5. TCP 담당 부분의 연결 끊기 동작
TCP 프로토콜의 규칙에 따르면 어느 쪽이 먼저 연결 끊기 동작을 실행해도 상관없음
* 웹의 경우 HTTP 프로토콜의 버전에 따라 다름 - 1.0이라면 서버에서 연결 끊기 동작을 시작

이 경우 연결 끊기 동작
* Socket 라이브러리의 close를 호출
  * TCP 담당 부분이 FIN 비트 1로 설정한 TCP 헤더를 만듬
* 이 패킷을 클라이언트로 보냄
* 클라이언트가 ACK 번호 반송
* 클라이언트가 close를 계속 호출하고 FIN 1인 헤더를 서버로 보냄
* 서버가 ACK 번호를 반송하면 연결 끊기 동작은 끝난다.