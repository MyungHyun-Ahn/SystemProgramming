# Story04 - 라우터의 부가 기능
## 1. 주소 변환으로 IP 주소를 효율적으로 이용한다
현재의 라우터는 몇 가지 부가 기능을 가지고 있다.
* 중요한 두 가지 기능
    * 주소 변환
    * 패킷 필터링

### 주소 변환 기능
등장 배경
* 주소는 각 기기를 식별하는 것 
    * 중복되지 않는 고유한 주소를 할당하는 것이 기본
* 인터넷에 접속하는 기기는 원래 고유의 주소를 가져야만 하는 것
    * 사내 LAN을 인터넷에 접속할 경우 - 주소를 일원화 하여 관리 기관에서 IP 주소를 취득하고 사내의 모든 기기에 설정
* 지금과 같이 사내의 PC와 공개용 서버라는 구별이 없고 클라이언트도 포함하여 모두 공개용
* 1990년대 이후 접속 댓가 늘어나며 사정이 바뀜
    * IP 주소의 고갈 문제

IP 주소 고갈 문제를 해결하는 방법
* 어떤 것을 가지고 고유하다고 간주할 것인가
* 사내의 기기에 할당하는 주소는 다른 회사와 중복되어도 좋다고 결정
* 특정 주소를 사내용으로 사용한다는 규칙을 세움
    * private address : 위 규칙에 기초한 사내용 주소
    * global address : 기존의 고유 주소

프라이비트 주소의 규칙
* 사내에서 사용하는 것은 아래의 범위로 한정
    * 10.0.0.0 ~ 10.255.255.255
    * 172.16.0.0 ~ 172.31.255.255
    * 192.168.0.0 ~ 192.168.255.255
* 이 범위는 미사용의 글로벌 주소 중에서 선택한 것
* 다른 회사와 중복해도 좋으므로 일원화하여 관리하지 않는다.
* 누구나 자유롭게 사용할 수 있다.

그러나 주소는 절약할 수 있지만 문제는 해결되지 않는다.
* 사내 네트워크는 완전히 독립되어 있는 것이 아닌 인터넷을 통해 많은 회사에 연결됨
* 패킷이 사내와 인터넷을 왕래하면 여기저기에 같은 주소가 있게 되어 패킷을 정확하게 운반할 수 없게 된다.

사내 네트워크를 인터넷에 공개하는 부분과 사내용 네트워크의 두 가지로 나눈다.
* 공개용 서버쪽에는 글로벌 주소를 할당하고 인터넷과 직접 통신
* 사내 네트워크에는 프라이빗 주소를 할당하고 인터넷과는 직접 패킷을 주고받지 않도록 특별한 구조를 사용
    * 이 구조가 바로 주소 변환

## 2. 주소 변환의 기본 동작
주소 변환의 구조
* 패킷을 중계할 때 IP 헤더에 기재된 IP 주소와 포트 번호를 바꿔쓰는 것

웹 서버에 엑세스할 때 흐르는 패킷을 차례대로 살펴보자
1. TCP의 접속 동작에서 최초로 흐르는 패킷을 인터넷에 중계할 때
    * 송신처의 IP 주소를 프라이빗 주소에서 글로벌 주소로 바꿔 씀
    * 여기서 사용하는 글로벌 주소는 주소 변환 장치의 인터넷측에 있는 포트에 할당된 주소
    * 이것과 동시에 포트 번호도 바꾸어 씀
    * 포트 번호쪽은 미사용 번호를 주소 변환 장치가 적당히 선택하여 사용
    * 바꿔쓴 후에는 글로벌 주소와 포트 번호를 한 세트로 주소 변환 장치 내부에 있는 대응표에 기록
2. 패킷을 인터넷에 송출
3. 패킷은 서버에 도착하고 회신 패킷이 돌아옴
    * 송신처에 회신을 돌려보내므로 회신 패킷의 수신처는 바꿔쓴 글로벌 주소와 포트 번호
    * 즉, 회신 패킷은 주소 변환 장치에 돌아옴
4. 주소 변환 장치에서 주소의 대응표에서 수신처와 대응하는 주소와 포트 번호로 바꿔쓴다.
5. 사내 네트워크에 패킷을 보내 송신처에 응답 패킷이 도착

이후 패킷을 주고받을 때도 비슷하게 패킷을 중계
* 인터넷에 대한 접속 동작이 끝나면 대응표에 등록한 것을 삭제
* 이렇게 하여 프라이빗 주소의 기기도 인터넷에 접속할 수 있다.

인터넷의 입장에서는 주소 변환 장치(라우터)가 통신 상대로 되어 있는 것으로 보임

## 3. 포트 번호를 바꿔쓰는 이유
초기의 주소 변환은 포트 번호 바꿔쓰기를 실행하지 않고 주소만 바꿔썼음
* 프라이빗 주소와 글로벌 주소가 1 대 1로 대응해서 인터넷에 접속하는 대수만큼 글로벌 주소가 필요
* 너무 많은 글로벌 주소가 필요하다.

포트 번호도 바꿔쓰는 방법은 이 점을 개선하기 위해 고안
* 포트 번호는 16비트
* 이것을 글로벌 주소와 세트로 하여 프라이빗 주소에 대응시키면 한 개의 글로벌 주소를 수만개의 프라이빗 주소에 대응시킬 수 있다.

## 4. 인터넷에서 회사로 액세스한다
사내에서 인터넷으로 액세스하는 패킷을 중계
* 대응표에 없어도 적당히 비어있는 것을 사용하면 되므로 문제가 없음

인터넷에서 사내로 패킷을 중계
* 대응표에 등록되어 있지 않으면 중계가 불가능
* 등록한 포트 번호 이외에는 포트에 패킷을 보낼 수 없음
    * 부정 침입을 방지하는 효과도 있음
* 대응표에 수동으로 등록하여 서버를 공개할 수 있음

## 5. 라우터의 패킷 필터링 기능
패킷 필터링
* 패킷을 중계할 때 MAC 헤더, IP 헤더, TCP 헤더에 기록되어 있는 내용을 조사하여 그것이 조건에 맞으면 폐킷을 중계하거나 폐기하는 동작을 실행
* 방화벽이나 소프트웨어는 이 원리를 이용하여 부정 침입을 방지

