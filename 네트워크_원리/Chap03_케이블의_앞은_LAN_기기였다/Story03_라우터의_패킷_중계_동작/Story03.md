# Story03 - 라우터의 패킷 중계 동작
## 1. 라우터의 기본
라우터 중계의 원리는 스위칭 허브와 비슷
* 그러나 구체적인 동작은 다르다.
* 라우터의 바탕이 되는 IP라는 개념이 스위칭 허브의 바탕이 되는 이더넷과 다르기 때문

라우터 내부 구조
* 중계 부분
  * 패킷의 중계 대상을 판단하는 동작을 담당
* 포트 부분
  * 패킷을 송수신하는 동작을 담당
  * 이더넷과 무선 LAN 이외에 하드웨어를 장착하면 다양한 통신 기술 지원 가능

라우터의 동작
1. 포트 부분에서 패킷을 수신
   * 이더넷 - 이더넷 규칙
   * 무선 LAN - 무선 LAN 규칙
   * 하드웨어에 의뢰하여 패킷을 수신
2. 중계 부분에서 받은 패킷의 IP 패킷에 기록되어 있는 수신처 IP 주소와 중계 대상을 등록한 표를 대조하여 중계 대상을 판단
3. 중계 대상측의 포트로 패킷을 옮기고 포트 부분의 하드웨어 규칙에 따라 패킷 송신 동작을 실행
   * 포트 부분에 의뢰하여 패킷을 송신
   * 포트 부분의 패킷이 송신처 또는 수신처가 되어 패킷을 송수신

## 2. 경로표에 등록된 정보
라우터는 IP 헤더에 기재되어 있는 수신처 IP 주소로 중계 대상을 판단
* 스위칭 허브와 테이블의 내용이 다르다.

라우팅 테이블
* 라우터의 테이블
* 수신처, 넷마스크, 게이트웨이, 인터페이스, 메트릭 정보가 포함

라우팅 테이블의 정보
* 수신처 : 수신처 정보
  * 호스트 번호는 무시하고 네트워크 번호 부분만 조사
* 넷마스크 : 네트워크 번호의 비트 수 판단

그런데 실제로 서브넷에 할당된 넷마스크의 값과 경로표에 등록된 넷마스크의 값이 다를 수 있다.

주소 집약
* 몇 개의 서브넷을 모아서 한 개의 서브넷으로 간주한 후 묶은 서브넷을 경로표에 등록할 수 있다.
* 예를 들어 10.10.1.0/24, 10.10.2.0/24, 10.10.3.0/24 라는 3개의 서브넷을 묶어 10.10.0.0/16이라는 서브넷으로 간주
* 이렇게 하여 경로표에 등록하는 건수를 줄일 수 있다.

이와 반대로 서브넷을 세분화 시킬 수도 있다.

게이트웨이(IP) 항목과 인터페이스(포트) 항목
* 패킷의 중계 대상을 나타냄

메트릭
* 수신처 IP 주소에 기록되어 있는 목적지가 가까운지, 먼지를 나타냄
* 수가 작으면 가까운 것 크면 먼 것

라우터는 패킷을 중계할 때 경로표의 내용에 손대지 않는다.

라우터의 경로표에 경로 정보를 등록하는 방법
1. 사람이 수동으로 경로 정보를 등록/갱신
2. 라우팅 프로토콜이라는 구조를 사용하여 라우터들끼리 경로 정보를 교환하고 라우터가 자체에서 경로표에 등록
   * RIP, OSPF, BGP

## 3. 라우터의 패킷 수신 동작
라우터의 포트는 여러가지가 있지만 여기서는 이더넷의 포트에서 패킷 수신 동작에 초점

이더넷 포트 부분의 구조
* PC의 LAN 어댑터와 거의 같음
* 패킷을 버퍼 메모리에 저장하는 부분까지의 동작도 거의 같다.

먼저 신호가 커넥터 부분에 도착하면
* PHY 회로와 MAC 회로가 디지털 데이터로 변환
* FCS 오류 유무 검사
* 정상이면 패킷을 수신 버퍼 메모리에 저장
  * 자신의 패킷이 아니라면 폐기

## 4. 경로표를 검색하여 출력 포트를 발견한다
패킷 수신 동작이 끝나면 MAC 헤더를 폐기
* MAC 헤더의 역할은 여기까지

MAC 헤더 뒤의 IP 헤더 내용을 보고 패킷 중계 동작에 들어감
1. 경로표에서 중계 대상을 조사
2. 경로표에서 수신처 항목을 조사하여 패킷의 수신처 IP 주소에 해당하는 행을 찾는다.
3. 넷마스크 항목에 등록된 값에서 네트워크 번호 부분만 비교