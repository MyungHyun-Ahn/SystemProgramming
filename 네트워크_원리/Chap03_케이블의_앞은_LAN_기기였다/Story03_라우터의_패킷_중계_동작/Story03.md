# Story03 - 라우터의 패킷 중계 동작
## 1. 라우터의 기본
라우터 중계의 원리는 스위칭 허브와 비슷
* 그러나 구체적인 동작은 다르다.
* 라우터의 바탕이 되는 IP라는 개념이 스위칭 허브의 바탕이 되는 이더넷과 다르기 때문

라우터 내부 구조
* 중계 부분
  * 패킷의 중계 대상을 판단하는 동작을 담당
* 포트 부분
  * 패킷을 송수신하는 동작을 담당
  * 이더넷과 무선 LAN 이외에 하드웨어를 장착하면 다양한 통신 기술 지원 가능

라우터의 동작
1. 포트 부분에서 패킷을 수신
   * 이더넷 - 이더넷 규칙
   * 무선 LAN - 무선 LAN 규칙
   * 하드웨어에 의뢰하여 패킷을 수신
2. 중계 부분에서 받은 패킷의 IP 패킷에 기록되어 있는 수신처 IP 주소와 중계 대상을 등록한 표를 대조하여 중계 대상을 판단
3. 중계 대상측의 포트로 패킷을 옮기고 포트 부분의 하드웨어 규칙에 따라 패킷 송신 동작을 실행
   * 포트 부분에 의뢰하여 패킷을 송신
   * 포트 부분의 패킷이 송신처 또는 수신처가 되어 패킷을 송수신

## 2. 경로표에 등록된 정보
라우터는 IP 헤더에 기재되어 있는 수신처 IP 주소로 중계 대상을 판단
* 스위칭 허브와 테이블의 내용이 다르다.

라우팅 테이블
* 라우터의 테이블
* 수신처, 넷마스크, 게이트웨이, 인터페이스, 메트릭 정보가 포함

라우팅 테이블의 정보
* 수신처 : 수신처 정보
  * 호스트 번호는 무시하고 네트워크 번호 부분만 조사
* 넷마스크 : 네트워크 번호의 비트 수 판단

그런데 실제로 서브넷에 할당된 넷마스크의 값과 경로표에 등록된 넷마스크의 값이 다를 수 있다.

주소 집약
* 몇 개의 서브넷을 모아서 한 개의 서브넷으로 간주한 후 묶은 서브넷을 경로표에 등록할 수 있다.
* 예를 들어 10.10.1.0/24, 10.10.2.0/24, 10.10.3.0/24 라는 3개의 서브넷을 묶어 10.10.0.0/16이라는 서브넷으로 간주
* 이렇게 하여 경로표에 등록하는 건수를 줄일 수 있다.

이와 반대로 서브넷을 세분화 시킬 수도 있다.

게이트웨이(IP) 항목과 인터페이스(포트) 항목
* 패킷의 중계 대상을 나타냄

메트릭
* 수신처 IP 주소에 기록되어 있는 목적지가 가까운지, 먼지를 나타냄
* 수가 작으면 가까운 것 크면 먼 것

라우터는 패킷을 중계할 때 경로표의 내용에 손대지 않는다.

라우터의 경로표에 경로 정보를 등록하는 방법
1. 사람이 수동으로 경로 정보를 등록/갱신
2. 라우팅 프로토콜이라는 구조를 사용하여 라우터들끼리 경로 정보를 교환하고 라우터가 자체에서 경로표에 등록
   * RIP, OSPF, BGP

## 3. 라우터의 패킷 수신 동작
라우터의 포트는 여러가지가 있지만 여기서는 이더넷의 포트에서 패킷 수신 동작에 초점

이더넷 포트 부분의 구조
* PC의 LAN 어댑터와 거의 같음
* 패킷을 버퍼 메모리에 저장하는 부분까지의 동작도 거의 같다.

먼저 신호가 커넥터 부분에 도착하면
* PHY 회로와 MAC 회로가 디지털 데이터로 변환
* FCS 오류 유무 검사
* 정상이면 패킷을 수신 버퍼 메모리에 저장
  * 자신의 패킷이 아니라면 폐기

## 4. 경로표를 검색하여 출력 포트를 발견한다
패킷 수신 동작이 끝나면 MAC 헤더를 폐기
* MAC 헤더의 역할은 여기까지

MAC 헤더 뒤의 IP 헤더 내용을 보고 패킷 중계 동작에 들어감
1. 경로표에서 중계 대상을 조사
2. 경로표에서 수신처 항목을 조사하여 패킷의 수신처 IP 주소에 해당하는 행을 찾는다.
3. 넷마스크 항목에 등록된 값에서 네트워크 번호 부분만 비교
4. 중계 대상의 후보를 찾음

만약 복수의 후보가 발견된다면
* 네트워크 번호의 비트 수가 가장 긴 것을 찾는다.
  * 네트워크 번호의 비트 수가 길다는 것은 호스트 번호의 비트 수가 짧다는 것
  * 호스트 번호의 비트 수가 짧다 -> 호스트 번호로 할당 가능한 번호의 수가 적다는 것
  * 서브넷이 작다 -> 범위가 축소
* 위 방법이 중계 대상을 정확하게 판단할 수 있다.

예시
* 192.168.1.0/255.255.255.0 -> 서브넷
* 192.168.1.10/255.255.255.255 -> 서버
* 서버가 속한 서브넷을 나타내는 주소보다 서버 자체를 나타내는 주소쪽이 범위가 축소되므로 서버를 선택
* 이렇게 후보가 1개만 남으면 이것을 중계 대상으로 삼는다.

만약 네트워크 번호의 길이가 같은 것이 여러 행 존재한다면?
* 라우터의 고장이나 케이블의 단선 등을 고려하여 우회로를 두는 경우
* 메트릭 값으로 판단
  * 메트릭 값이 작다면 - 가까이 있는 것
  * 이것을 선택

해당하는 행이 한 개도 발견되지 않는 경우
* 라우터는 패킷을 폐기
* ICMP 메시지로 송신처에 이 사실을 통지
* 스위칭 허브는 크지 않은 네트워크를 가정하여 만들어 모든 포트에 패킷을 뿌려도 문제가 되지 않음
* 라우터는 매우 크기 때문에 엄청난 양의 패킷을 뿌릴 수 없다.
* 따라서 중계 대상이 분명하지 않은 패킷을 폐기한다.

## 5. 해당하는 경로가 없는 경우에 선택하는 기본 경로
라우터에 중계 대상을 전부 등록해야 하는 상황
* 인터넷의 중계 대상은 20만을 넘으므로 전부 등록하는 것은 보통일이 아니다.

라우팅 테이블의 마지막 1행
* 중계 대상을 전부 등록한 것과 같은 역할
* 넷마스크가 0.0.0.0
  * 수신처 IP 주소와 비교할 때 비트 수가 0이라는 것이므로 비교 동작을 하지 않아도 됨
* 넷마스크를 0.0.0.0으로 하면 모든 주소에 일치한다는 의미

게이트웨이 항목
* 인터넷으로 나가는 라우터를 등록
* 다른 행에 해당하는 것이 없는 경우 패킷을 그곳으로 중계
* 기본 경로 - 기본 게이트웨이라고 함

이렇게 해서 중계 대상을 원할하게 검색 가능\
중계 대상이 분명하지 않은 사태도 방지 가능

## 6. 패킷은 유효 기한이 있다
라우팅 테이블에서 중계 대상을 찾아내고 패킷을 출력측의 포트로 옮기고 송신하기 전 해야할 일이 있다.

TTL(Time To Live, 생존 기간) - IP 헤더의 필드를 갱신
* 라우터를 경유할 때마다 이 값을 1씩 줄이다가 이 숫자가 0이 되면 패킷의 생존 기간이 만료되는 것으로 간주하고 폐기
* 패킷이 같은 장소를 순환하는 사태를 막기 위함
* 라우팅 테이블에 중계 대상이 정확하게 등록되어 있으면 이러한 사태는 발생하지 않음
* 하지만 기기의 고장 등에 의해 경로가 혼란에 빠지면 이러한 사태에 빠질 수 있다.
* 보통 64 혹은 128이라는 값을 설정
* 지구 반대편에 액세스하더라도 많아야 수십 개

## 7. 큰 패킷은 조각 나누기 기능으로 분할한다
라우터의 포트 부분
* 이더넷 뿐만 아닌 LAN이나 통신 회선의 경우도 있다.
* 이 종류에 따라 패킷의 최대 길이가 달라진다.
* 어느 경우든 중계하는 패킷의 크기가 출력측의 최대 길이를 초과하면 패킷을 송신할 수 없다.

이 경우 IP 프로토콜에 규정된 fragmentation이라는 방법을 사용
* 패킷을 분할하여, 패킷의 길이를 짧게 만든 후 중계
* TCP의 데이터 분할과는 다르다.
* fragmentation은 패킷이 만들어진 후에 패킷을 분할하는 것을 가리킴

조각 나누기의 동작
1. 출력측의 MTU를 조사하여 중계하는 패킷을 그대로 출력측에서 송신할 수 있는지 조사
2. 패킷의 최대 길이에서 헤더의 길이를 빼서 MTU를 산출하고 중계하는 패킷의 길이와 비교
3. 출력측의 MTU가 충분히 커서 분할하지 않아도 송신할 수 있으면 분할하지 않음
4. MTU가 작은 경우에는 패킷을 분할
  * 그 전에 IP 헤더의 플래그 필드를 조사하여 분할해도 좋을지 확인
  * 만약 플래그 필드가 분할 불가라면 패킷을 폐기하고 ICMP 메시지로 송신처에 통지
5. TCP 헤더의 이후 부분을 분할 대상 데이터로 간주하고 분할
  * 분할한 데이터에 IP 헤더를 복사하지만 일부 필드는 고쳐 씀
  * 조각 나누기로 분할한 핵심 정보를 IP 헤더에 기록하기 위함

IP 헤더의 분할 플래그 필드가 분할 불가인 경우
* 송신처의 애플리케이션에서 분할 불가로 설정
* 이미 패킷이 분할되어 있는 경우

## 8. 라우터의 송신 동작은 컴퓨터와 같다
이렇게 해서 송신 전의 일이 끝나고 패킷의 송신 동작으로 넘어감
* 이때의 동작은 출력측의 포트에 따라 다르다.
* 이더넷, ADSL 등의 규칙에 따름

이더넷의 패킷 송신 동작
* 프로토콜 스택의 IP 담당 부분이 패킷을 보낼 때와 같다.
* 패킷의 맨 앞에 MAC ㅔ더를 부가하여 값을 설정 후 전기 신호로 전환하여 보낸다.

MAC 헤더의 맨 앞에 수신처 MAC 주소에 값을 설정
* 게이트웨이 항목에서 패킷을 건네줄 상대를 판단.
* 게이트웨이에 IP 주소가 쓰여있으면 여기가 건네줄 상대
* 비어있다면 수신처 IP 주소가 건네줄 상대
* IP 주소가 결정되면 ARP 프로토콜을 통해 MAC 주소를 조사하고 결과를 수신처 MAC 주소로 설정
  * 라우터에 ARP 캐시가 있으므로 먼저 ARP 캐시를 찾아보고 없으면 ARP로 조회를 시도한다.

송신처 MAC 주소 필드
* 출력측의 포트에 할당된 MAC 주소를 설정

타입 필드 - 0x0800

모든 값을 설정하고 전기 신호로 변환하여 송신

## 9. 라우터와 스위칭 허브의 관계
맨 앞의 MAC 헤더를 부가하는 부분이 중요
* 이더넷의 패킷의 데이터 부분에 IP의 패킷을 넣는다고 표현하는 것이 원래의 개념에 가까움
* IP의 구조는 스스로 패킷을 운반하는 수단이 없으므로 패킷을 운반할 때는 이더넷에 의뢰하여 운반

라우터와 스위칭 허브의 관계
* 라우터 - IP의 개념에 기초하여 설계
* 스위칭 허브 - 이더넷에 기초하여 설계
* 즉, IP와 이더넷의 관계가 라우터와 스위칭 허브의 관계를 나타냄

정리하면 라우터는 패킷을 운반하는 일을 스위칭 허브에 의뢰
* 각각 보았을 때의 관계이다.
* 실제로는 라우터에 스위칭 허브를 내장한 기종이 있다.

라우터가 스위칭 허브에 의뢰할 때의 개념
* IP가 이더넷에 의뢰하는 것은 최종 목적지까지 패킷을 운반하는 것이 아닌 다음 라우터에 패킷을 운반하는 것
  * MAC 헤더를 만들 때 IP 경로표에서 다음 라우터의 IP 주소를 조사
  * 여기서 ARP로 조사한 MAC 주소를 수신처 MAC 주소에 기록
* 이것이 바로 다음 라우터까지 패킷을 운반하도록 이더넷에 의뢰하는 것
* 이 동작을 반복하여 IP의 목적지까지 운반하는 것

통신 상대까지 패킷을 전달하는 전체의 동작은 IP(라우터)가 담당\
이 동작을 할 때 다음 라우터까지 패킷을 운반하는 부분은 이더넷(스위칭 허브)이 담당

다른 회선 또한 비슷한 관계를 가진다.