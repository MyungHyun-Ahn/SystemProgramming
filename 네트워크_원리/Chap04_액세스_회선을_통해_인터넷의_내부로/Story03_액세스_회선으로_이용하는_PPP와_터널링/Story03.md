# Story03 - 액세스 회선으로 이용하는 PPP와 터널링
## 1. 본인 확인과 설정 정보를 통지한다
BAS
* 인터넷은 원래 다수의 라우터를 함께 연결하여 만든 것 - 액세스 회선을 라우터에 연결하는 것이 원칙
* 액세스 회선이 ADSL이나 FTTM으로 진화
* 이것에 맞게 진화한 라우터가 바로 BAS

### 라우터에서 진화한 기능
본인 확인과 설정값 통지
* ADSL이나 FTTH의 액세스 회선은 최초에 사용자명과 패스워드를 입력하여 로그인을 하지않으면 인터넷에 액세스 불가
* 이때 BAS가 로그인 동작의 창구 역할이 됨
* 이 역할을 실현하기 위해 PPPoE 구조 사용
  * PPP에서 진화한 것

PPP의 동작
* 프로바이더의 액세스 포인트에 전화를 검
* 전화가 연결되면 사용자명과 패스워드를 입력하여 로그인 조작
* 사용자명과 패스워드는 RADIUS라는 프로토콜을 사용하여 RAS에서 인증 서버에 전송
* 인증 서버에서 정확한지 검사
* 정확하다면 인증 서버에서 IP 주소 등의 설정 정보가 반송 - 여기가 가장 중요
* 사용자의 PC는 이 정보에 따라 IP 주소 등을 설정
* TCP/IP의 송수신 준비 완료

## 2. 이더넷에서 PPP 메시지를 주고받는 PPPoE
PPP의 구조가 반드시 전부 필요한 것은 아니다.
* ADSL이나 FTTH는 사용자와 BAS를 케이블로 고정적으로 접속하므로 본인 확인이 필요없다.
* 그러나 사용자명과 패스워드를 입력하는 동작을 남겨두면
  * 사용자명에 따라 프로바이더를 전환할 수 있다.

## 3. 터널링 기능에 의해 프로바이더에 패킷을 전달한다
터널링
* 소켓과 소켓 사이를 연결하는 TCP의 커넥션과 비슷
* 한쪽의 터널링 출입구에 헤더를 포함한 패킷 전체를 넣으면 그대로의 모습으로 반대쪽 출입구에 도달

BAS와 ADSL/FTTH 접속 서비스 사업자의 네트워크 안에 터널을 만듬
* 여기에 사용자와 BAS를 연결하는 액세스 회선을 연결하면
* 사용자로부터 프로바이더의 라우터까지 한 개의 길이 만들어져 패킷이 그 길을 통해 인터넷 내부로 들어가는 형태가 됨

TCP의 커넥션을 사용하여 터널링을 실현
* 터널링용 라우터 사이에 TCP 커넥션을 만듬
* 커넥션 양끝에 있는 소켓에 해당하는 부분을 라우터의 포트로 간주하고
* 여기로 패킷을 송수신

캡슐화 방법으로 터널링을 실현
* 헤더도 포함한 패킷 전체를 별도의 패킷 안에 저장하여 터널의 한쪽 출입구까지 운반하는 것

패킷을 그대로의 모습으로 운반할 수 있는 구조라면 어떤 것에도 터널링을 이용 가능

## 4. 액세스 회선 전체의 동작
액세스 회선 동작의 추적
1. 사용자 측에 인터넷 접속용 라우터를 설치하고 인터넷에 접속한 곳부터 시작
2. 인터넷 접속자용 라우터에 프로바이더가 할당한 사용자명과 패스워드를 등록하면 PPPoE의 Discovery하는 구조에 따라 BAS를 검색
   * 인터넷의 브로드캐스트를 이용한 것
3. BAS의 MAC 주소를 알고 BAS와 통신할 수 있게 된 것

사용자명과 패스워드를 BAS에 보내는 부분
* 패스워드를 암호화 하는 CHAP
* 암호화하지 않는 PAP
  * 암호화하지 않더라도 즉시 패스워드가 도청되는 것은 아님
  * BAS와 인터넷 접속용 라우터 사이뿐만 데이터가 흐른다.
  * 평범한 방법으로는 도청 불가능

패스워드를 확인한 후 BAS에서 TCP/IP의 설정 정보를 통지하는 부분
* 여기서 통지하는 정보
  * IP 주소, DNS 서버의 IP 주소, 기본 게이트웨이의 IP 주소
* 인터넷 접속용 라우터를 사용할 경우에는 이 설정 정보를 인터넷 접속용 라우터가 받아서 라우터 자체에 설정
* 인터넷 접속용 라우터의 BAS측 포트에 글로벌 주소가 할당, 경로표에 기본 게이트웨이 설정
* 이로써 인터넷 접속용 라우터는 패킷을 인터넷에 중계할 수 있는 상태가 된다.

이후 클라이언트로부터 인터넷에 액세스하는 패킷이 흘러온다
* 누군가가 브라우저에서 인터넷에 액세스하면 패킷이 들어옴
* 이 패킷의 수신처는 인터넷의 어느 한 부분 - 경로표에 없다.
* 이 경우 기본 게이트웨이에 패킷을 중계

경로표에서 중계 대상을 판단한 후 패킷을 송신하는 부분
* PPPoE의 규칙을 따른 상태
* 진행 순서
  1. 송신하는 패킷에 헤더를 붙이고 값을 기록
       * MAC 수신처 주소에는 PPPoE의 Discovery에서 조사한 BAS의 MAC 주소
       * MAC 송신처 주소에는 인터넷 접속용 라우터의 BAS측 포트의 MAC 주소
       * 이더 타입에는 PPPoE를 나타내는 8864라는 값을 씀
  2. PPPoE 헤더와 PPP 헤더
       * 페이로드의 길이 이외에는 사전에 값이 결정
       * 페이로드의 길이는 패킷의 길이을 조사하면 알 수 있다.
  3. 이후 패킷을 신호로 변환하여 포트에서 송신
  4. BAS에 도착 BAS에서 MAC 헤더와 PPPoE 헤더를 제거하고
  5. PPP 헤더 이후의 부분을 추출한 후 터널링의 원리를 사용하여 패킷을 송신
  6. 반대쪽 출구를 향해 진행하고 프로바이더의 라우터에 도착

## 5. IP 어드레스를 할당하지 않는 언넘버드
라우터의 포트끼리 하나의 케이블로 연결하는 상태에 접속되어 있는 부분
* 예외없이 반대편에 도착
* 따라서 중계 대상의 주소를 조사하는 동작을 필요없다.
* IP 주소를 할당할 필요도 없다
  * 1 대 1인 부분에 모두 해당
* 이것을 언넘버드라고 함

## 6. 인터넷 접속용 라우터에서 프라이비트 주소를 글로벌 주소로 변환한다
BAS는 사용자측에 TCP/IP의 설정 정보를 통지
* 그런데 글로벌 주소는 라우터에 할당
* PC에는 글로벌 주소를 할당할 수 없다.

이 경우 PC에는 프라이빗 주소를 할당
* PC가 보낸 패킷은 인터넷 접속용 라우터에서 주소 변환한 후 인터넷에 중계
* 애플리케이션의 종류에 따라 주소 변환의 영향으로 정상 작동하지 않는것도 있을 수 있으니 주의

주소 변환의 영향으로 애플리케이션이 정상작동하지 않는다면
* 라우터를 사용하지 않고 BAS가 통지하는 PPPoE의 메시지를 PC가 받는 형태를 채택
* PC에 글로벌 주소를 할당
* 그러나 인터넷에 직접 패킷이 도착하므로 공격받을 가능성이 있다.
  * 방화벽 등으로 방어

## 7. PPPoE 이외의 방식
PPPoA 방법을 이용한 ADSL 액세스 회선
* PPPoE는 PPP 메시지를 일단 이더넷의 패킷에 저장한 후 셀에 저장
* PPPoA는 PPP 메시지를 그래도 셀에 저장
  * MAC 헤더와 PPPoE 헤더가 없는 것으로 사용자 유연성에 영향

PPPoA는 PPP 메시지를 그대로 이더넷에 전송할 수 없다.
* BAS와 PPP 메시지를 주고받는 기기, 즉 PC나 라우터를 ADSL 모뎀과 일체화하지 않으면 PPP의 구조가 동작하지 않음

일체화 시키는 방법
* PC와 USB 인터페이스에 ADSL 모뎀을 연결하여 일체화 시키는 방법
  * 보급되지 않고 끝남
* ADSL 모뎀과 라우터를 일체화시킨 라우터 일체형 ADSL 모뎀을 사용하는 방법
  * PPPoE에서 라우터를 사용하는 경우와 차이가 거의 없기 때문에 널리 보급
  * 그러나 라우터를 사용하지 않고 PC를 인터넷에 연결한다는 대책을 마련하지 않았기 때문에 주소 변환에서 문제가 발생하면 곤란

PPPoA가 PPPoE보다 좋은 면
* PPPoE는 헤더가 부가되어 그만큼 MTU가 짧아짐
* MTU가 짧아짐에 따라 효율성이 떨어질 수 있다.

PPPoA와 PPPoE의 제약
* PPPoE : 효율성 저하
* PPPoA : ADSL 모뎀과 라우터를 분리할 수 없다는 제약

DHCP
* PPP 대신 사용하는 구조
* TCP/IP의 설정 정보를 BAS에서 사용자측에 통지하는 방법을 선택
* 주로 사내 LAN에서 클라이언트 PC에 TCP/IP의 설정 정보를 통지하기 위해 널리 사용됨
* 사용자명과 패스워드 조차 사용하지 않음
* 단순히 인터넷의 패킷을 주고받기만 하므로 MTU가 짧아지지 않음
* 셀을 사용하지 않음으로 ADSL 모뎀과 라우터를 분리할 수 없다는 제약도 없음