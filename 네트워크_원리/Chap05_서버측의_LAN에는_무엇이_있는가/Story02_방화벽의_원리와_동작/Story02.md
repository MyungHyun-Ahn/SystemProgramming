# Story02 - 방화벽의 원리와 동작
## 1. 패킷 필터링형이 주류이다
지금은 서버의 설치 장소와 관계 없이 지금은 바로 앞에 방화벽이 있는 것이 보통

방화벽의 기본 개념
* 특정 서버와 해당 서버 안의 특정 애플리케이션에 액세스하는 패킷만 통과
* 그러나 상당히 많은 패킷이 흐르므로 통과시킬 패킷을 구분하는 것은 어려움

다양한 방법이 있다.

## 2. 패킷 필터링의 조건 설정 개념
패킷 헤더의 제어 정보를 조사하면 여러 사항을 알 수 있음

### 패킷 헤더 조건에 사용하는 것

MAC 헤더
* 송신처 MAC 주소

IP 헤더
* 송신처 IP 주소
* 수신처 IP 주소
* 프로토콜 번호

TCP 헤더 또는 UDP 헤더
* 송신처 포트 번호
* 수신처 포트 번호
* TCP 컨트롤 ㅂ트
* 프래그먼트

헤더가 아니라 ICMP 메시지의 내용

### 패킷 필터링의 조건
패킷의 흐름에 착안
* 수신처 IP 주소, 송신처 IP 주소에 따라 시점과 종점 판단
* 시점은 모르지만 종점은 웹 서버
* 이것을 조건으로 해당하는 패킷만 통과
* 인터넷측에서 웹 서버로 흘러가는 패킷은 방화벽을 통과

이것만으로는 액세스 동작이 제대로 작동하지 않는다.
* 수신 확인 응답 구조가 작용
* 웹 서버 -> 인터넷으로 흐르는 패킷도 존재
    * 웹 서버에서 인터넷측으로 흘러간 후 그곳에서 시점이 웹 서버의 주소에 일치하는 패킷도 통과

이처럼 패킷이 어디서 어디로 흐르는지를 판단하는 것이 첫걸음


## 3. 애플리케이션을 한정할 때 포트 번호를 사용한다
웹 이외의 애플리케이션의 패킷을 전부 차단하는 것이 좋다.
* TCP 헤더나 UDP 헤더에 있는 포트 번호를 조건으로 추가

## 4. 컨트롤 비트로 접속 방향을 판단한다
위까지 해도 웹 서버에서 인터넷측에 액세스하는 동작을 정지시킬 수 없기 때문

웹의 동작은 TCP 프로토콜로 양방향으로 패킷이 흐름
* 단순히 웹 서버에서 인터넷으로 흐르는 패킷을 정지시키면 웹 서버에 액세스하는 동작도 정지됨

패킷이 흐르는 방향이 아닌 액세스 방향을 판단하여 정지시켜야 한다.
* 여기서 TCP 헤더의 컨트롤 비트를 사용
  * 최초의 패킷만 SYN이 1, ACK는 0
  * 다른 패킷에서 같은 값을 취하는 경우는 없으므로
  * 이 값으로 최초의 패킷과 두 번째 이후의 패킷 판별 가능

인터넷측에서 웹 서버에 액세스하는 패킷
* TCP 컨트롤 비트의 조건이 두 번째 행과 합치되지 않음 -> 세 번째 행의 조건에 합치
* 패킷 필터링을 통과

결국 인터넷 -> 웹 서버에 액세스할 때 흐르는 패킷은 전부 패킷 필터링을 통과

실제로 통과시키는 것과 차단하는 것을 완전히 선별할 수 없는 경우
* DNS 서버에 대한 액세스
  * UDP를 사용하므로 TCP처럼 컨트롤 비트에 의해 액세스 방향을 판별할 수 없다.
  * 이 성질은 UDP를 사용하는 모든 애플리케이션에 공통

## 5. 사내 LAN에서 공개 서버용 LAN으로 조건을 설정한다
사내 LAN과 인터넷 또는 공개 서버용 LAN을 왕래하는 패킷의 조건도 설정해야 함
* 조건이 서로 악영향을 끼치지 않도록 주의

## 6. 밖에서 사내 LAN으로 액세스할 수 없다
인터넷과 사내 LAN을 왕래하는 패킷은 주소 변환을 해야 하므로 설정이 필요
* 패킷의 시점과 종점을 조건으로 지정한 후 주소 변환이 필요하면 주소 변환, 아니면 안함
* 주소와 포트의 대응은 자동으로 할 수 있으므로 주소 변환을 해야할지 설정

주소 변환을 이용하면 사내 LAN에는 액세스할 수 없게됨
* 사내 LAN에 대한 액세스를 금지하도록 패킷 필터링 조건을 걸 필요가 없음

## 7. 방화벽을 통과한다
방화벽에 필터링되면 기록을 남김
* 이것을 분석하여 향후 대책에 도움이 될 수 있음

통과시킨 판정 이후
* 패킷을 중계한다.
* 라우터의 동작과 같다.
* 그 이상의 특별한 구조는 없다.

## 8. 방화벽으로 막을 수 없는 공격
시점과 종점을 보고 판단
* 특수한 데이터를 포함한 패킷을 받으면 웹 서버가 다운
* 특수한 데이터는 방화벽에서 보지 않음

두 가지 대처법
1. 소프트웨어의 버그를 고친다.
2. 패킷의 내용을 조사하여 위험한 데이터가 포함되어 있는 경우 패킷을 차단
   * 소프트웨어를 방화벽과는 별도로 준비해야 한다.

그런데 패킷의 내용이 위험
* 웹 서버에 버그가 있는지의 여부로 결정
* 버그를 고치는 방법이 낫다.