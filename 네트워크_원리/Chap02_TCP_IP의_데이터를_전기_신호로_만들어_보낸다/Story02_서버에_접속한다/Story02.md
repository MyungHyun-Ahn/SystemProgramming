# Story 02 - 서버에 접속한다.
## 1. 접속의 의미
이더넷, 통신 회선은 항상 케이블이 연결
* 언제든지 신호를 보낼 수 있다.

소켓을 만든 직후에 애플리케이션에서 데이터 송신 의뢰가 오면 프로토콜 스택은 어떻게 될까?
* 이 시점에는 아무 것도 기록되어 있지 않음 - 통신 상대를 모른다.
* 서버의 IP 주소나 포트 번호를 프로토콜 스택에 알리는 동작이 필요
  * 이것이 접속 동작의 한 가지 역할

서버측은?
* 마찬가지로 통신 상대를 모른다.
* 클라이언트에서 IP 주소와 포트 번호를 서버에 전달
  * 이것 또한 접속 동작의 역할 중 하나

접속의 첫 번째 동작
* 통신 상대와의 제어 정보를 주고 받아 소켓에 필요한 정보를 기록하고 데이터 송수신이 가능한 상태로 만드는 것

버퍼 메모리
* 송수신 데이터를 일시적으로 저장하는 메모리 영역
* 이 공간의 확보도 접속 동작을 할 때 실행
* '접속'의 의미

## 2. 맨 앞부분에 제어 정보를 기록한 해더를 배치한다.
TCP 헤더(20바이트~)
* 송신처 포트 번호 : 16비트
* 수신처 포트 번호 : 16비트
* 시퀀스 번호 : 32비트
  * 이 패킷의 맨 앞 위치의 데이터가 송신 데이터의 몇 번째 바이트에 해당하는지 수신측에 전달
* ACK 번호 : 32비트
  * 데이터가 몇 바이트까지 도착했는지
* 데이터 오프셋 : 4비트
  * 헤더의 길이
* 사용하지 않음 : 6비트
* 컨트롤 비트 : 6비트
  * 각 비트가 통신 제어상의 의미를 가짐
  * URG : 긴급 포인터 필드 유효
  * ACK : 일련 번호 필드가 유효, 보통 데이터가 올바르게 수신되었음을 의미
  * PSH : flush 동작에 의해 송신된 데이터
  * RST : 접속을 강제로 종료하고 이상 종료시 사용
  * SYN : 송신측과 수신측에서 일련번호를 서로 확인
  * FIN : 연결끊기를 의미
* 윈도우 : 16비트
  * 송신측에 윈도우 사이즈(수신 확인을 기다리지 않고 묶어서 송신할 수 있는 데이터의 양)를 통지하기 위해 사용
* 체크섬 : 16비트
  * 오류 유무 검사
* 긴급 포인터 : 16비트
  * 긴급하게 처리해야할 데이터의 위치를 나타냄
* 옵션 : 가변 길이
  * 헤더 이외의 제어 정보를 기록하기 위함
  * 접속 동작을 제외하면 사용하는 예는 적다.

제어 정보는 크게 2종류가 있다.
1. 클라이언트와 서버가 서로 연락을 절충하기 위해 주고받는 제어 정보
  * 접속 뿐만 아니라 송수신, 연결을 끊는 동작도 포함
   * 구체적으로는 위의 항목이 제어 정보
2. 소켓에 기록하여 프로토콜 스택의 동작을 제어하기 위한 정보
   * 애플리케이션에서 통지된 정보, 통신 상대로부터 받은 정보 등이 수시로 기록
   * 프로토콜 스택은 차례로 정보를 참조하며 동작
   * 소켓의 제어 정보는 프로토콜 스택의 프로그램과 일체화
   * 여기에 기록한 정보는 상대측에서 볼 수 없다.

## 3. 접속 동작의 실체
Socket 라이브러리의 connect를 호출
* connect(디스크립터, 서버측 IP, 포트, ...);
* 여기에 IP 주소와 포트를 쓰면 명령이 프로토콜 스택의 TCP 담당 부분에 전달
* TCP 담당 부분은 서버의 TCP 담당 부분과 제어 정보를 주고 받음

이때 진행 과정
1. 데이터 송수신 동작의 개시를 나타내는 제어 정보를 기록한 헤더를 만듬
   * 헤더 정보
     * 송신처, 수신처 포트 번호
     * SYN 컨트롤 비트 1로
2. IP 담당 부분에 TCP 헤더를 전달하여 송신을 의뢰
3. IP 담당 부분이 패킷 송신 동작을 실행
4. 패킷이 서버에 도착하면 서버측 IP 담당 부분이 TCP 담당 부분에 건네줌
5. 서버의 TCP 담당 부분이 TCP 헤더를 조사하여 수신처 포트 번호에 해당하는 소켓을 찾아냄
6. 해당 소켓을 찾으면 필요한 정보를 기록하고 접속 진행중 상태가 됨
7. 과정이 끝나면 서버의 TCP 담당부분은 응답을 돌려보냄

이후 클라이언트와 마찬가지로
1. 송신처와 수신처의 포트 번호나 SYN 비트 등을 설정한 TCP 헤더를 만든다.
   * ACK 컨트롤 비트 1로 - 패킷을 받은 것을 알리기 위함
2. TCP 헤더를 IP 담당 부분으로 넘겨 클라이언트에 반송
3. 패킷이 클라이언트로 돌아오고 TCP 담당 부분에 도착
4. SYN이 1이면 접속 성공 - 소켓에 접속 완료를 나타내는 제어 정보 기록
5. 패킷이 도착했다는 정보를 서버에 알리기 위해 ACK 비트를 1로 만든 TCP 헤더를 반송
6. 이것이 서버에 도착하면 접속 동작은 끝이 난다.

이로써 소켓은 데이터를 송수신할 수 있는 상태가 된다.
* 파이프로 연결된 것과 비슷 - 이 파이프를 커넥션이라 한다.