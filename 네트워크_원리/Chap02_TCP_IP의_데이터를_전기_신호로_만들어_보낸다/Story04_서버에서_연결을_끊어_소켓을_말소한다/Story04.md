# Story04 - 서버에서 연결을 끊어 소켓을 말소한다
## 1. 데이터 보내기를 완료했을 때 연결을 끊는다
데이터 보내기를 완료한 쪽에서 연결 끊기 단계로 진입
* Socket 라이브러리의 close를 호출

서버측 연결 끊기
* TCP 헤더를 만들고 연결 끊기 정보를 설정
  * 컨트롤 비트의 FIN 비트에 1을 설정
* IP 담당 부분에 의뢰하여 클라이언트에 송신해달라 요청
* 서버측 소켓에 연결 끊기 동작에 들어갔다는 정보 기록

클라이언트측
* 서버측 연결 끊기 패킷 도착
* 프로토콜 스택이 자신의 소켓에 연결 끊기 기록
* ACK 번호를 서버측에 반송하고
* 애플리케이션이 데이터를 가지러 올 때까지 대기
* 애플리케이션 read 호출
* 서버에서 보낸 데이터를 모두 수신 완료했다는 사실을 브라우저에게 알림
* 클라이언트에서도 close를 호출해서 데이터 송수신 동작을 끝냄
* 서버측과 마찬가지로 FIN 비트 1 설정 후 송신 -> 서버에서 ACK가 돌아오면 종료

# 2. 소켓을 말소한다
close 이후 소켓을 바로 말소시키지 않고 대기한다.

다음의 경우
1. 클라이언트가 FIN 송신
2. 서버가 ACK 번호 송신
3. 서버가 FIN 송신
4. 클라이언트가 ACK 번호 송신

이 경우 서버에는 ACK 번호가 돌아오지 않으므로 다시 FIN을 보낼 수 있다.
* 새 어플리케이션이 소켓을 같은 포트에 할당하면
* 다시 보낸 FIN이 새 소켓에 전달되며 오작동이 발생할 수 있다.

위의 경우 때문에 소켓을 대기하였다가 말소시킨다.
* 보통 이 대기 시간은 몇 분이다.

## 3. 데이터 송수신 동작을 정리한다
전체를 정리
* 데이터 송수신에서 최초의 동작은 소켓을 작성
* 보통은 서버측에서 애플리케이션이 동작하기 시작했을 때 소켓을 만들고 이것을 접속 대기 상태로 만듬
* 클라이언트측은 사용자가 무언가 조치를 취하여 서버에 액세스하는 동작이 시작될 때 패킷을 작성
* 이 단계에서는 아직 패킷을 주고받지 않음

접속 동작
1. 클라 -> 서버 SYN : 1, 시퀀스 번호 초기값 - 윈도우
2. 서버 -> 클라 : ACK 번호, 윈도우 - SYN : 1, 시퀀스 번호 초기값
3. 클라 -> 서버 : ACK 번호

송수신 동작
1. 클라 -> 서버 : 시퀀스 번호 + 데이터
2. 서버 -> 클라 : ACK 번호, 윈도우
3. 서버 -> 클라 : 시퀀스 번호 + 데이터
4. 클라 -> 서버 : ACK 번호, 윈도우

연결 끊기
1. 서버 -> 클라 : FIN : 1
2. 클라 -> 서버 : ACK 번호
3. 클라 -> 서버 : FIN : 1
4. 서버 -> 클라 : ACK 번호